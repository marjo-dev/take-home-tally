<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TakeHome Tally</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#121212" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="IncomeTracker" />
    <link rel="apple-touch-icon" href="icons/icon-96.png" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="wrap">
      <header class="app-header">
        <h1>üçΩÔ∏è TakeHome Tally üçΩÔ∏è</h1>
        <p class="muted">A simple way to keep track of your hours, tips, and deductions. See what you actually take home each week and keep your earnings organized with clear, easy-to-read summaries.
        </p>
        <!-- NAVIGATION BAR FOR MOBILE-FIRST LAYOUT -->
        <nav class="top-nav" aria-label="Primary pages">
          <button data-page="entry" aria-controls="page-entry">Daily Entry</button>
          <button data-page="summary" aria-controls="page-summary">Weekly Summary</button>
          <button data-page="ytd" aria-controls="page-ytd">Year-to-Date</button>
          <button data-page="settings" aria-controls="page-settings">Settings</button>
        </nav>
      </header>
      <main class="page-stack">
        <section id="page-settings" class="page">
          <!-- SETTINGS + ROLE MANAGER -->
          <div class="grid two">
            <!-- SETTINGS -->
            <div class="card">
              <h2>‚öôÔ∏è Settings</h2>
              <label
                >Tax Rate (%)
                <input type="number" id="set-tax" step="0.1" inputmode="decimal" />
              </label>
              <label
                >401(k) (% of gross)
                <input type="number" id="set-k401" step="0.1" inputmode="decimal" />
              </label>
              <label
                >Employer Match (%)
                <input type="number" id="set-match" step="0.1" inputmode="decimal" />
              </label>
              <label
                >Other Deductions (%)
                <input type="number" id="set-other" step="0.1" inputmode="decimal" />
              </label>
              <label
                >App Color Scheme
                <select id="set-theme">
                  <option value="dark">Dark</option>
                  <option value="light">Light</option>
                </select>
              </label>
              <button id="save-settings">Save Settings</button>
              <span class="muted">Saved locally in your browser.</span>
            </div>

            <!-- ROLE MANAGER -->
            <div class="card">
              <h2>üë§ Role Manager</h2>
              <label
                >Role Name
                <input type="text" id="role-name" placeholder="Server" />
              </label>
              <label
                >Hourly Rate ($)
                <input
                  type="number"
                  id="role-rate"
                  step="0.01"
                  placeholder="10.00"
                  inputmode="decimal"
                />
              </label>
              <button id="add-role" class="btn-ghost">Add / Update Role</button>

              <div class="table-wrap" style="margin-top: 10px">
                <table id="roles-table">
                  <thead>
                    <tr>
                      <th>Role</th>
                      <th class="num">Hourly Rate</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="muted">Roles appear in the Daily Entry dropdown.</div>
            </div>
          </div>
          <div class="card center">
            <h2>üíæ Backup / Restore</h2>
            <p class="muted">
              Export or back up your data, reset everything, or import saved
              entries.
            </p>

            <div class="button-row">
              <div class="button-with-help">
                <button id="export-data" class="btn-ghost">Backup Data</button>
                <button type="button" class="info-btn" data-help="Creates a JSON backup file containing your saved settings and entries.">‚ìò</button>
              </div>
              <div class="button-with-help">
                <button id="export-csv" class="btn-ghost">Export Data</button>
                <button type="button" class="info-btn" data-help="Exports a CSV spreadsheet of all entries for spreadsheets or further analysis.">‚ìò</button>
              </div>
            </div>

            <div class="button-row">
              <div class="button-with-help">
                <label
                  for="import-json"
                  class="btn-ghost small"
                  style="cursor: pointer"
                  >ü™Ñ Restore from Backup</label
                >
                <button type="button" class="info-btn" data-help="Restores a JSON backup created from this app. Existing data will be replaced.">‚ìò</button>
              </div>
              <div class="button-with-help">
                <button id="reset-data" class="btn-danger">Reset All Data</button>
                <button type="button" class="info-btn" data-help="Deletes every entry and setting from this device. This action cannot be undone without a backup.">‚ìò</button>
              </div>
              <input
                type="file"
                id="import-json"
                accept=".json,application/json"
                style="display: none"
              />
            </div>

            <p class="muted" style="margin-top: 10px">
              ‚ö†Ô∏è Reset permanently deletes all entries, roles, and settings.
            </p>
          </div>
        </section>
        <section id="page-entry" class="page active">
          <!-- DAILY ENTRY -->
          <div class="card entry-card">
            <h2>üóìÔ∏è Daily Entry</h2>

            <form id="daily-entry-form" class="entry-column">
              <label
                >Date
                <div class="date-input-wrap">
                  <input type="date" id="entry-date" required autofocus />
                  <button id="today-btn" type="button" class="btn-ghost small">
                    Today
                  </button>
                </div>
              </label>

              <label
                >Role
                <select id="entry-role"></select>
              </label>

              <label
                >Hours Worked
                <input
                  type="number"
                  id="entry-hours"
                  step="0.1"
                  placeholder="e.g. 6.5"
                  required
                  inputmode="decimal"
                />
              </label>

              <label
                >Credit Card Tips Earned ($)
                <input
                  type="number"
                  id="entry-tips"
                  step="0.01"
                  placeholder="Credit tips"
                  inputmode="decimal"
                />
              </label>

              <label
                >Cash Tips Earned ($)
                <input
                  type="number"
                  id="entry-cash"
                  step="0.01"
                  placeholder="Cash tips"
                  inputmode="decimal"
                />
              </label>

              <label
                >Tip-Outs ($)
                <input
                  type="number"
                  id="entry-tipouts"
                  step="0.01"
                  placeholder="Tip-outs given"
                  inputmode="decimal"
                />
              </label>

              <div class="entry-footer">
                <button id="add-entry" type="button">Add Daily Entry</button>
              </div>
            </form>
          </div>
        </section>
        <section id="page-summary" class="page">
          <!-- WEEKLY SUMMARY -->
          <div class="card summary-card">
            <h2>üìÖ Weekly Summary</h2>

            <div class="summary-toolbar">
              <label for="month-filter">Filter by Month</label>
              <select id="month-filter">
                <option value="all">All months</option>
              </select>
            </div>

            <h3 class="section-header">Weekly Breakdown</h3>
            <p class="section-subtext">Detailed week-by-week totals based on the selected month filter.</p>

            <div class="table-wrap">
              <table id="weekly-table">
                <thead>
                  <tr>
                    <th>Pay Period</th>
                    <th class="num">Hours Worked</th>
                    <th class="num">Hourly Wages</th>
                    <th class="num">Total Credit Card Tips</th>
                    <th class="num">Total Cash Tips</th>
                    <th class="num">Gross Income</th>
                    <th class="num">Taxable Income</th>
                    <th class="num">Estimated Tax Deduction</th>
                    <th class="paydate">Pay Date</th>
                    <th class="num net-header">
                      <div>Net Income</div>
                      <div>(Estimated Paycheck Amount)</div>
                    </th>
                    <th class="num">Total Take-Home Amount</th>
                    <th class="num">Total Tip-Outs</th>
                    <th class="num">Retirement Contribution</th>
                    <th class="num">Employer Match</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="15" class="muted">No data yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
        <section id="page-ytd" class="page">
          <div class="card summary-card">
            <h2>üìä Year-to-Date Overview</h2>
            <p class="section-subtext">Cumulative totals and weekly averages across all recorded pay periods.</p>

            <div class="stats-paired">
              <div>
                <strong>Total Weeks:</strong> <span id="stat-weeks">0</span>
              </div>
              <div>
                <strong>Average Hours/Week:</strong>
                <span id="avg-hours">0.00 h</span>
              </div>

              <div>
                <strong>Year-to-Date Gross:</strong> <span id="stat-gross">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Gross:</strong>
                <span id="avg-gross">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Tax:</strong> <span id="stat-tax">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Tax:</strong>
                <span id="avg-tax">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Retirement:</strong>
                <span id="stat-retire">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Retirement:</strong>
                <span id="avg-retire">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Net:</strong> <span id="stat-net">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Net:</strong>
                <span id="avg-net">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Tip-Outs:</strong>
                <span id="stat-tipouts">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Tip-Outs:</strong>
                <span id="avg-tipouts">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Take-Home:</strong>
                <span id="stat-takehome">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Take-Home:</strong>
                <span id="avg-takehome">$0.00</span>
              </div>
            </div>
          </div>
        </section>
      </main>

    <!-- Script -->
    <script src="script.js"></script>
    <script>
      if ("serviceWorker" in navigator) {
        let refreshing = false;

        // Register service worker
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./service-worker.js")
            .then((reg) => {
              console.log("‚úÖ Service Worker registered", reg.scope);

              // Check for updates periodically (every hour)
              setInterval(() => {
                reg.update();
              }, 60 * 60 * 1000);

              // Listen for service worker updates
              reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                console.log('üîÑ New service worker found, installing...');
                
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New service worker is ready, reload to activate it
                    console.log('‚úÖ New version available! Reloading...');
                    if (!refreshing) {
                      refreshing = true;
                      window.location.reload();
                    }
                  }
                });
              });
            })
            .catch((err) => console.error("‚ùå Service Worker failed", err));
        });

        // Handle service worker controller change (when new one takes over)
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            refreshing = true;
            window.location.reload();
          }
        });
      }

      // PWA Install Prompt Handler
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('‚úÖ Install prompt available');
        // You can show a custom install button here if needed
      });

      // Log install event
      window.addEventListener('appinstalled', () => {
        console.log('‚úÖ PWA installed successfully');
        deferredPrompt = null;
      });
    </script>
    <!--NAVIGATION BAR SCRIPT-->
    <script>
      const navButtons = Array.from(document.querySelectorAll(".top-nav button"));
      const pages = Array.from(document.querySelectorAll(".page"));

      const activatePage = (pageKey) => {
        const targetId = `page-${pageKey}`;
        pages.forEach((page) => {
          page.classList.toggle("active", page.id === targetId);
        });

        navButtons.forEach((button) => {
          const isActive = button.dataset.page === pageKey;
          button.classList.toggle("is-active", isActive);
          button.setAttribute("aria-pressed", isActive ? "true" : "false");
          if (isActive) {
            button.setAttribute("aria-current", "page");
          } else {
            button.removeAttribute("aria-current");
          }
        });
      };

      navButtons.forEach((button) => {
        button.addEventListener("click", () => activatePage(button.dataset.page));
      });

      const initialPage = document.querySelector(".page.active")?.id.replace("page-", "") || "entry";
      activatePage(initialPage);
    </script>
  </body>
</html>
