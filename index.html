<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TakeHome Tally</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#f5f7fb" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="TakeHome Tally" />
    <link rel="apple-touch-icon" href="icons/icon-96.png" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="wrap">
      <header class="app-header">
        <h1><img src="icons/icon-96.png" alt="TakeHome Tally" style="width: 24px; height: 24px;"> TakeHome Tally</h1>
        <div class="app-description">
          <button type="button" class="app-description-toggle expanded" aria-expanded="true" aria-controls="app-description-content">
            <span class="toggle-label">About This App</span>
            <span class="toggle-hint muted">tap to hide</span>
          </button>
          <div id="app-description-content" class="app-description-content expanded">
            <p class="user-tips">Welcome! TakeHome Tally gives you a simple way to keep track of your hours, tips and deductions. Predict your paycheck amount before you get paid and see what you actually take home each week. Stay on top of your changing income with simple weekly insights.
            </p>
            <p class="user-tips">
              <strong>Note:</strong> This app runs right in your web browser.<br>
              You can bookmark this page to return anytime, or "install üì≤" it to your phone's home screen for a more app-like experience:
            </p>
            <ul class="user-tips-list">
              <li><strong>iPhone:</strong> tap <em>Share ‚Üí Add to Home Screen</em></li>
              <li><strong>Android:</strong> tap the <em>menu (‚ãÆ)</em> and choose <em>Add to Home screen</em></li>
            </ul>
            <p class="user-tips">üí° <strong>User Tips:</strong> Navigate using the buttons at the bottom of the screen. If it's your first time using the app, first go to the Settings page to set your tax rates, retirement contributions, employer match, and any other deductions.
              <ul class="user-tips-list">
                <li><strong>Daily Entry:</strong> Log your shifts here.</li>
                <li><strong>Weekly Summary:</strong> Here is where you'll find your weekly summaries: it'll show your income breakdown by week, your estimated paycheck amount, and your total take-home amount.</li>
                <li><strong>Year-to-Date:</strong> View your year-to-date totals and per week averages. This is a great way to see your income trends over time.</li>
                <li><strong>Settings:</strong> Configure your settings here. Set tax rate and retirement contributions in the Settings card, add or edit your roles and hourly rates in the Role Manager card.</li>
              </ul>
            </p>
            <p class="user-tips">
              If you want to report a bug, have any questions or want to give feedback, feel free to fill out  <em><a href="https://forms.gle/tTRXMWqUSMBzHDTP6">this google form</a></em>. In fact, I'd love to hear from you!
            </p>
            <p class="muted">
              For more information, check out the <em><a href="https://github.com/marjo-dev/take-home-tally/blob/main/README.md" target="_blank" rel="noopener noreferrer">README</a></em> on GitHub. There you can read more about the app, its features, and its planned enhancements.
            </p>
            <p class="muted">
              You can hide this message by tapping the "About This App" button at the top ‚¨ÜÔ∏è of this card.
            </p>
          </div>
        </div>
        <!-- NAVIGATION BAR FOR MOBILE-FIRST LAYOUT -->
        <nav class="top-nav" aria-label="Primary pages">
          <button data-page="entry" aria-controls="page-entry">Daily Entry</button>
          <button data-page="summary" aria-controls="page-summary">Weekly Summary</button>
          <button data-page="ytd" aria-controls="page-ytd">Year-to-Date</button>
          <button data-page="settings" aria-controls="page-settings">Settings</button>
        </nav>
      </header>
      <main class="page-stack">
        <section id="page-settings" class="page">
          <!-- SETTINGS + ROLE MANAGER + BACKUP/RESTORE -->
          <div class="grid settings-grid">
            <!-- SETTINGS -->
            <div class="card">
              <h2>‚öôÔ∏è Settings</h2>
              <div class="settings-description">
                <button type="button" class="settings-description-toggle expanded" aria-expanded="true" aria-controls="settings-description-content">
                  <span class="toggle-label">About Settings</span>
                  <span class="toggle-hint muted">tap to hide</span>
                </button>
                <div id="settings-description-content" class="settings-description-content expanded">
                  <p class="user-tips">
                    Set your tax rates, retirement contributions, employer match, and any other deductions. The next card down (Role Manager) will allow you to add or edit your roles and hourly rates.
                    These values are saved locally and used to estimate your weekly take-home pay.
                  </p>
                  <p class="user-tips">
                    Note: This app provides estimates only ‚Äî it doesn't calculate your exact taxes or retirement contributions. 
                    Your actual paycheck may differ based on your employer's payroll system and specific withholdings.
                  </p>
                  <p class="user-tips">
                    By default, a 20% tax deduction is applied to taxable income ‚Äî a reasonable starting point for most tipped workers.
                  </p>
                  <p class="user-tips">
                    If you don't have a 401(k), Roth 401(k), or employer match, you can leave those at 0%. The same goes for any other optional deductions.
                  </p>
                  <p class="muted">
                    You can update these settings anytime to refresh your estimated take-home pay.
                  </p>
                  <p class="muted">
                    You can hide this message by tapping the "About Settings" button at the top ‚¨ÜÔ∏è of this card.
                  </p>      
                </div>
              </div>
              <div class="card-divider"></div>
              <div class="entry-column">
                <div class="label-group">
                  <label
                    ><span>Tax Rate (%)</span>
                    <input type="number" id="set-tax" step="0.1" inputmode="decimal" />
                  </label>
                </div>
                <div class="label-group">
                  <label
                    ><span>401(k) (% of gross)</span>
                    <input type="number" id="set-k401" step="0.1" inputmode="decimal" />
                  </label>
                </div>
                <div class="label-group">
                  <label
                    ><span>Roth 401(k) (% of gross)</span>
                    <input type="number" id="set-roth401k" step="0.1" inputmode="decimal" />
                  </label>
                </div>
                <div class="label-group">
                  <label
                    ><span>Employer Match (%)</span>
                    <input type="number" id="set-match" step="0.1" inputmode="decimal" />
                  </label>
                </div>
                <div class="label-group">
                  <label
                    ><span>Other Deductions (%)</span>
                    <input type="number" id="set-other" step="0.1" inputmode="decimal" />
                  </label>
                </div>
                <div class="label-group">
                  <label
                    ><span>App Color Scheme</span>
                    <select id="set-theme">
                      <option value="dark">Dark</option>
                      <option value="light">Light</option>
                    </select>
                  </label>
                </div>
              </div>
              <button id="save-settings">Save Settings</button><br>
            </div>

            <!-- ROLE MANAGER -->
            <div class="card">
              <h2>üë§ Role Manager</h2>
              <p class="user-tips">Set up your roles and hourly rates here. These roles will appear in the Daily Entry dropdown menu when you log your shift. You can add or edit roles as needed, and delete any roles you don't need anymore.</p>
              <div class="card-divider"></div>
              <div class="entry-column">
                <div class="label-group">
                  <label
                    ><span>Role Name</span>
                    <input type="text" id="role-name" placeholder="Add role here" />
                  </label>
                </div>
                <div class="label-group">
                  <label
                    ><span>Hourly Rate ($)</span>
                    <input
                      type="number"
                      id="role-rate"
                      step="0.01"
                      placeholder="example: 10.00"
                      inputmode="decimal"
                    />
                  </label>
                </div>
              </div>
              <button id="add-role">Add / Update Role</button>

              <div class="table-wrap" style="margin-top: 10px; width: 100%">
                <table id="roles-table">
                  <thead>
                    <tr>
                      <th>Role</th>
                      <th class="num">Hourly Rate</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>              
            </div>

            <!-- BACKUP / RESTORE -->
            <div class="card">
              <h2>üíæ Backup / Restore</h2>
              <p class="user-tips">
                Here is where you can back up your app data, or export your entries to a spreadsheet. You can also reset everything if you want to start fresh, and restore from a backup.
              </p>

              <div class="button-list">
                <div class="button-with-help">
                  <button id="export-data">Backup Data</button>
                  <button type="button" class="info-btn" data-help="[Backup Data] creates a JSON backup file containing your saved settings and entries. Save it somewhere safe, like your cloud storage. This file can be imported later to restore your data in this app. You can make multiple backups if you want, just be sure to keep track of which one is the most recent.">‚ìò</button>
                </div>
                <div class="button-with-help">
                  <button id="export-csv">Export Data</button>
                  <button type="button" class="info-btn" data-help="[Export Data] exports a CSV file of all your entries. This file can be opened in a spreadsheet app like Excel, Numbers, or Google Sheets.">‚ìò</button>
                </div>
                <div class="button-with-help">
                  <label
                    for="import-json"
                    class="button-label"
                    style="cursor: pointer"
                    >ü™Ñ Restore from Backup</label
                  >
                  <button type="button" class="info-btn" data-help="[Restore from Backup] restores a previously created JSON backup file. Existing data will be replaced. Make sure to choose the most recent backup file to avoid losing any data.">‚ìò</button>
                </div>
                <div class="button-with-help">
                  <button id="reset-data" class="btn-danger">Reset All Data</button>
                  <button type="button" class="info-btn" data-help="[Reset All Data] deletes every entry and setting from this device if you want to start fresh. This action cannot be undone, so make sure you make a backup first if you want to keep your data.">‚ìò</button>
                </div>
                <input
                  type="file"
                  id="import-json"
                  accept=".json,application/json"
                  style="display: none"
                />
              </div>
            </div>
          </div>
        </section>
        <section id="page-entry" class="page active">
          <!-- DAILY ENTRY -->
          <div class="card entry-card">
            <h2>üóìÔ∏è Daily Entry</h2>

            <form id="daily-entry-form" class="entry-column">
              <div class="label-group">
                <label
                  ><span>Date</span>
                  <div class="date-input-wrap">
                    <input type="date" id="entry-date" required autofocus />
                    <button id="today-btn" type="button" class="btn-ghost small">
                      Today
                    </button>
                  </div>
                </label>
                <span class="muted helper-text">Select the date from the calendar or tap the Today button to set current date</span>
              </div>

              <div class="label-group">
                <label
                  ><span>Role</span>
                  <select id="entry-role"></select>
                </label>
                <span class="muted helper-text">Select role from the dropdown menu</span>
              </div>

              <div class="label-group">
                <label
                  ><span>Hours Worked</span>
                  <input
                    type="number"
                    id="entry-hours"
                    step="0.1"
                    placeholder="Hours worked in shift"
                    required
                    inputmode="decimal"
                  />
                </label>
                <span class="muted helper-text">Write in the exact number on your time card after clocking out</span>
              </div>

              <div class="label-group">
                <label
                  ><span>Credit Card Tips ($)</span>
                  <input
                    type="number"
                    id="entry-tips"
                    step="0.01"
                    placeholder="Credit card tips earned"
                    inputmode="decimal"
                  />
                </label>
                <span class="muted helper-text">Write in the exact amount found in your shift report</span>
              </div>

              <div class="label-group">
                <label
                  ><span>Cash Tips ($)</span>
                  <input
                    type="number"
                    id="entry-cash"
                    step="0.01"
                    placeholder="Cash tips earned"
                    inputmode="decimal"
                  />
                </label>
                <span class="muted helper-text">Write in the amount you earned before tipping out co-workers</span>
              </div>

              <div class="label-group">
                <label
                  ><span>Tip-Outs ($)</span>
                  <input
                    type="number"
                    id="entry-tipouts"
                    step="0.01"
                    placeholder="Tip-outs given"
                    inputmode="decimal"
                  />
                </label>
                <span class="muted helper-text">Write in the total amount you tipped out for this shift</span>
              </div>

              <div class="entry-footer">
                <button id="add-entry" type="button">Add Daily Entry</button>
              </div>
            </form>
          </div>
        </section>
        <section id="page-summary" class="page">
          <!-- WEEKLY SUMMARY -->
          <div class="card summary-card">
            <h2>üìÖ Weekly Summary</h2>

            <div class="summary-toolbar">
              <label for="month-filter">Filter by Month</label>
              <select id="month-filter">
                <option value="all">All months</option>
              </select>
            </div>

            <p class="section-subtext">Detailed week-by-week totals. You can filter by month to see breakdowns for a specific month. Tap the Pay Period header to expand the details for that week.</p>

            <div class="table-wrap">
              <table id="weekly-table">
                <thead>
                  <tr>
                    <th>Pay Period</th>
                    <th class="num">Hours Worked</th>
                    <th class="num">Hourly Wages</th>
                    <th class="num">Total Credit Card Tips</th>
                    <th class="num">Total Cash Tips</th>
                    <th class="num">Gross Income</th>
                    <th class="num">Taxable Income</th>
                    <th class="num">Estimated Tax Deduction</th>
                    <th class="paydate">Pay Date</th>
                    <th class="num net-header">
                      <div>Net Income</div>
                      <div>(Estimated Paycheck Amount)</div>
                    </th>
                    <th class="num">Total Take-Home Amount</th>
                    <th class="num">Total Tip-Outs</th>
                    <th class="num">Retirement Contribution</th>
                    <th class="num">Employer Match</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="15" class="muted">No data yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
        <section id="page-ytd" class="page">
          <div class="card summary-card">
            <h2>üìä Year-to-Date Overview</h2>
            <p class="section-subtext">Cumulative totals and weekly averages across all recorded pay periods.</p>

            <div class="stats-paired">
              <div>
                <strong>Total Weeks:</strong> <span id="stat-weeks">0</span>
              </div>
              <div>
                <strong>Average Hours/Week:</strong>
                <span id="avg-hours">0.00 h</span>
              </div>

              <div>
                <strong>Year-to-Date Gross:</strong> <span id="stat-gross">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Gross:</strong>
                <span id="avg-gross">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Tax:</strong> <span id="stat-tax">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Tax:</strong>
                <span id="avg-tax">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Retirement:</strong>
                <span id="stat-retire">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Retirement:</strong>
                <span id="avg-retire">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Net:</strong> <span id="stat-net">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Net:</strong>
                <span id="avg-net">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Tip-Outs:</strong>
                <span id="stat-tipouts">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Tip-Outs:</strong>
                <span id="avg-tipouts">$0.00</span>
              </div>

              <div>
                <strong>Year-to-Date Take-Home:</strong>
                <span id="stat-takehome">$0.00</span>
              </div>
              <div>
                <strong>Average Weekly Take-Home:</strong>
                <span id="avg-takehome">$0.00</span>
              </div>
            </div>
          </div>
        </section>
      </main>

    <!-- Script -->
    <script src="script.js"></script>
    <script>
      if ("serviceWorker" in navigator) {
        let refreshing = false;

        // Register service worker
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./service-worker.js")
            .then((reg) => {
              console.log("‚úÖ Service Worker registered", reg.scope);

              // Check for updates periodically (every hour)
              setInterval(() => {
                reg.update();
              }, 60 * 60 * 1000);

              // Listen for service worker updates
              reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                console.log('üîÑ New service worker found, installing...');
                
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New service worker is ready, reload to activate it
                    console.log('‚úÖ New version available! Reloading...');
                    if (!refreshing) {
                      refreshing = true;
                      window.location.reload();
                    }
                  }
                });
              });
            })
            .catch((err) => console.error("‚ùå Service Worker failed", err));
        });

        // Handle service worker controller change (when new one takes over)
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            refreshing = true;
            window.location.reload();
          }
        });
      }

      // PWA Install Prompt Handler
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('‚úÖ Install prompt available');
        // You can show a custom install button here if needed
      });

      // Log install event
      window.addEventListener('appinstalled', () => {
        console.log('‚úÖ PWA installed successfully');
        deferredPrompt = null;
      });
    </script>
    <!--NAVIGATION BAR SCRIPT-->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const navButtons = Array.from(document.querySelectorAll(".top-nav button"));
        const pages = Array.from(document.querySelectorAll(".page"));

        const activatePage = (pageKey) => {
          const targetId = `page-${pageKey}`;
          pages.forEach((page) => {
            page.classList.toggle("active", page.id === targetId);
          });

          navButtons.forEach((button) => {
            const isActive = button.dataset.page === pageKey;
            button.classList.toggle("is-active", isActive);
            button.setAttribute("aria-pressed", isActive ? "true" : "false");
            if (isActive) {
              button.setAttribute("aria-current", "page");
            } else {
              button.removeAttribute("aria-current");
            }
          });
        };

        navButtons.forEach((button) => {
          button.addEventListener("click", () => activatePage(button.dataset.page));
        });

        const initialPage = document.querySelector(".page.active")?.id.replace("page-", "") || "entry";
        activatePage(initialPage);
      });
    </script>
    <!--APP DESCRIPTION TOGGLE SCRIPT-->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const toggleButton = document.querySelector(".app-description-toggle");
        const content = document.getElementById("app-description-content");
        
        if (toggleButton && content) {
          toggleButton.addEventListener("click", () => {
            const isExpanded = content.classList.contains("expanded");
            
            if (isExpanded) {
              content.classList.remove("expanded");
              toggleButton.classList.remove("expanded");
              toggleButton.setAttribute("aria-expanded", "false");
              const hint = toggleButton.querySelector(".toggle-hint");
              if (hint) hint.textContent = "tap to expand";
            } else {
              content.classList.add("expanded");
              toggleButton.classList.add("expanded");
              toggleButton.setAttribute("aria-expanded", "true");
              const hint = toggleButton.querySelector(".toggle-hint");
              if (hint) hint.textContent = "tap to hide";
            }
          });
        }
      });
    </script>
    <!--SETTINGS DESCRIPTION TOGGLE SCRIPT-->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const toggleButton = document.querySelector(".settings-description-toggle");
        const content = document.getElementById("settings-description-content");
        
        if (toggleButton && content) {
          toggleButton.addEventListener("click", () => {
            const isExpanded = content.classList.contains("expanded");
            
            if (isExpanded) {
              content.classList.remove("expanded");
              toggleButton.classList.remove("expanded");
              toggleButton.setAttribute("aria-expanded", "false");
              const hint = toggleButton.querySelector(".toggle-hint");
              if (hint) hint.textContent = "tap to expand";
            } else {
              content.classList.add("expanded");
              toggleButton.classList.add("expanded");
              toggleButton.setAttribute("aria-expanded", "true");
              const hint = toggleButton.querySelector(".toggle-hint");
              if (hint) hint.textContent = "tap to hide";
            }
          });
        }
      });
    </script>
  </body>
</html>
